---
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Stats array (expanded)
const stats = [
  { value: "20+", label: "Years Experience" },
  { value: "500+", label: "Cases Won" },
  { value: "98%", label: "Success Rate" },
  { value: "50M+", label: "In Recoveries" },
  { value: "4.9/5", label: "Avg. Rating" },
  { value: "100+", label: "5-Star Reviews" },
];

// Precompute numeric targets and suffixes for animation
const enhancedStats = stats.map((s) => {
  const str = String(s.value);
  const match = str.match(/^(\d+[\d,.]*)(.*)$/);
  const numberPart = match ? match[1] : str;
  const suffix = match ? match[2] : "";
  const target = Number(numberPart.replace(/,/g, ""));
  const decimals = (numberPart.split(".")[1] || "").length;
  return { ...s, target: isNaN(target) ? 0 : target, suffix, decimals };
});
---

<section aria-label="Key statistics">
  <Wrapper variant="standard" class="py-16">
    <div class="max-w-3xl">
      <Text tag="p" variant="textSM" class="text-accent-700 font-semibold tracking-wide uppercase">
        Proven Results
      </Text>
      <Text tag="h2" variant="displayMD" class="text-base-600 mt-2">
        Results that speak for themselves
      </Text>
      <Text tag="p" variant="textLG" class="text-base-400 mt-3">
        Weâ€™ve built a track record of winning difficult cases and delivering
        meaningful outcomes for our clients. Here are a few numbers behind our work.
      </Text>
    </div>

    <ul class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-x-8 gap-y-8 mt-10">
      {
        enhancedStats.map((stat) => (
          <li>
            <Text tag="p" variant="displayLG" class="text-base-600">
              <span
                class="countup"
                data-target={stat.target}
                data-suffix={stat.suffix}
                data-decimals={stat.decimals}
                aria-label={`${stat.value} ${stat.label}`}
              >
                {stat.value}
              </span>
            </Text>
            <Text tag="p" variant="textSM" class="text-base-400 mt-1">
              {stat.label}
            </Text>
          </li>
        ))
      }
    </ul>
  </Wrapper>

  <script is:inline>
    // Simplified count-up: IntersectionObserver + requestAnimationFrame
    // Keeps SSR values as fallback; animates once on first view.
    window.addEventListener("DOMContentLoaded", () => {
      const items = document.querySelectorAll(".countup");
      if (!("IntersectionObserver" in window) || items.length === 0) return;

      const ease = (t) => 1 - Math.pow(1 - t, 3); // easeOutCubic

      const animate = (el) => {
        const target = Number(el.dataset.target || "0");
        const suffix = el.dataset.suffix || "";
        const decimals = Number(el.dataset.decimals || "0");
        const duration = 1000; // ms
        const startTime = performance.now();

        const step = (now) => {
          const t = Math.min((now - startTime) / duration, 1);
          const raw = target * ease(t);
          const value = decimals ? Number(raw.toFixed(decimals)) : Math.round(raw);
          el.textContent = value.toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals,
          }) + suffix;
          if (t < 1) requestAnimationFrame(step);
        };

        // Optional: quick init to zero to avoid a brief drop from final SSR value
        el.textContent = (0).toLocaleString(undefined, {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals,
        }) + suffix;
        requestAnimationFrame(step);
      };

      const io = new IntersectionObserver((entries) => {
        entries.forEach((e) => {
          if (e.isIntersecting) {
            io.unobserve(e.target);
            if (!e.target.dataset.animated) {
              e.target.dataset.animated = "true";
              animate(e.target);
            }
          }
        });
      }, { threshold: 0.35 });

      items.forEach((el) => io.observe(el));
    });
  </script>
</section>
